<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Demandes Ing√©nierie</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Gestion des Demandes Ing√©nierie</h1>
            <p>Conseil patrimonial et analyse financi√®re personnalis√©e</p>
            <div class="zeendoc-info">
                <span class="zeendoc-badge">üìÅ Int√©gration ZeenDoc Automatique</span>
                <small>Documents automatiquement envoy√©s vers votre d√©p√¥t ZeenDoc + Email aux ing√©nieurs</small>
            </div>
        </div>

        <div class="form-container">
            <form id="ingenierieForm">
                <!-- Informations g√©n√©rales -->
                <div class="form-section">
                    <div class="section-title">Informations g√©n√©rales</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="nomConseiller">Nom du conseiller *</label>
                            <input type="text" id="nomConseiller" name="nomConseiller" required>
                        </div>
                        <div class="form-group">
                            <label for="secteurConseiller">Secteur/Localisation du conseiller *</label>
                            <select id="secteurConseiller" name="secteurConseiller" required>
                                <option value="">S√©lectionner...</option>
                                <option value="Le Havre">Le Havre</option>
                                <option value="Rouen">Rouen</option>
                                <option value="Paris">Paris</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="typologieContact">Typologie du contact *</label>
                            <select id="typologieContact" name="typologieContact" required>
                                <option value="">S√©lectionner...</option>
                                <option value="Client">Client</option>
                                <option value="Prospect">Prospect</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dateDemande">Date de la demande *</label>
                            <input type="date" id="dateDemande" name="dateDemande" required>
                        </div>
                        <div class="form-group">
                            <label for="dateRdv">Date du prochain RDV</label>
                            <input type="date" id="dateRdv" name="dateRdv">
                        </div>
                        <div class="form-group">
                            <label for="urgence">Urgence *</label>
                            <select id="urgence" name="urgence" required>
                                <option value="Normal">Normal</option>
                                <option value="Urgent">Urgent</option>
                                <option value="Tr√®s urgent">Tr√®s urgent</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="origineContact">Origine du contact</label>
                            <select id="origineContact" name="origineContact">
                                <option value="">S√©lectionner...</option>
                                <option value="Client du PTF">Client du PTF</option>
                                <option value="Client apport√© par la direction">Client apport√© par la direction</option>
                                <option value="Client apport√© par un salari√© OC">Client apport√© par un salari√© OC</option>
                                <option value="Client apport√© par Progressia">Client apport√© par Progressia</option>
                                <option value="Client externe apporter par le CGP">Client externe apporter par le CGP</option>
                                <option value="Recommandation">Recommandation</option>
                                <option value="Prospection">Prospection</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Contacts -->
                <div class="form-section">
                    <div class="section-title">Contacts</div>
                    <div class="contacts-container">
                        <div class="contact-card">
                            <div class="card-header">
                                <span class="card-icon">üë§</span>
                                <h3>Contact 1</h3>
                            </div>
                            <div class="card-content">
                                <div class="form-group">
                                    <label for="nomContact1">Nom *</label>
                                    <input type="text" id="nomContact1" name="nomContact1" required>
                                </div>
                                <div class="form-group">
                                    <label for="prenomContact1">Pr√©nom *</label>
                                    <input type="text" id="prenomContact1" name="prenomContact1" required>
                                </div>
                            </div>
                        </div>

                        <div class="contact-card">
                            <div class="card-header">
                                <span class="card-icon">üë§</span>
                                <h3>Contact 2 (optionnel)</h3>
                            </div>
                            <div class="card-content">
                                <div class="form-group">
                                    <label for="nomContact2">Nom</label>
                                    <input type="text" id="nomContact2" name="nomContact2">
                                </div>
                                <div class="form-group">
                                    <label for="prenomContact2">Pr√©nom</label>
                                    <input type="text" id="prenomContact2" name="prenomContact2">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-grid" style="margin-top: 20px;">
                        <div class="form-group">
                            <label for="situationFamiliale">Situation familiale *</label>
                            <select id="situationFamiliale" name="situationFamiliale" required>
                                <option value="">S√©lectionner...</option>
                                <option value="C√©libataire">C√©libataire</option>
                                <option value="Mari√©">Mari√©</option>
                                <option value="Pacs√©">Pacs√©</option>
                                <option value="Concubin">Concubin</option>
                                <option value="Divorc√©">Divorc√©</option>
                                <option value="Veuf">Veuf</option>
                            </select>
                        </div>
                        <div class="form-group conditional-field" id="regimeGroup" style="display: none;">
                            <label for="regimeMatrimonial">R√©gime matrimonial / Type de PACS</label>
                            <select id="regimeMatrimonial" name="regimeMatrimonial">
                                <option value="">S√©lectionner...</option>
                                <option value="Communaut√© r√©duite aux acqu√™ts">Communaut√© r√©duite aux acqu√™ts</option>
                                <option value="Communaut√© universelle">Communaut√© universelle</option>
                                <option value="S√©paration de biens">S√©paration de biens</option>
                                <option value="Participation aux acqu√™ts">Participation aux acqu√™ts</option>
                                <option value="PACS civil">PACS civil</option>
                                <option value="PACS notari√©">PACS notari√©</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Objectifs patrimoniaux -->
                <div class="form-section">
                    <div class="section-title">Objectifs patrimoniaux</div>
                    
                    <div class="objectifs-common-section">
                        <label class="checkbox-item objectifs-common-checkbox">
                            <input type="checkbox" id="objectifsCommunsCheckbox" name="objectifsCommuns" checked>
                            <span class="checkmark"></span>
                            <strong>Les objectifs sont communs aux deux contacts</strong>
                        </label>
                        <p class="help-text">Si cette case n'est pas coch√©e, vous pourrez d√©finir des objectifs diff√©rents pour chaque contact.</p>
                    </div>

                    <!-- Objectifs communs -->
                    <div id="objectifsCommuns" class="form-card">
                        <div class="card-header">
                            <span class="card-icon">üéØ</span>
                            <h3>Objectifs patrimoniaux</h3>
                        </div>
                        <div class="card-content">
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="objectifs" value="Constitution d'un patrimoine">
                                    <span class="checkmark"></span>
                                    Constitution d'un patrimoine
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="objectifs" value="Pr√©paration de la retraite">
                                    <span class="checkmark"></span>
                                    Pr√©paration de la retraite
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="objectifs" value="Optimisation fiscale">
                                    <span class="checkmark"></span>
                                    Optimisation fiscale
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="objectifs" value="Transmission du patrimoine">
                                    <span class="checkmark"></span>
                                    Transmission du patrimoine
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="objectifs" value="Diversification des investissements">
                                    <span class="checkmark"></span>
                                    Diversification des investissements
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="objectifs" value="Protection du conjoint/famille">
                                    <span class="checkmark"></span>
                                    Protection du conjoint/famille
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="objectifs" value="Financement des √©tudes">
                                    <span class="checkmark"></span>
                                    Financement des √©tudes
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="objectifs" value="Investissement locatif">
                                    <span class="checkmark"></span>
                                    Investissement locatif
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Objectifs s√©par√©s -->
                    <div id="objectifsSepares" style="display: none;">
                        <div class="objectifs-container">
                            <div class="form-card">
                                <div class="card-header">
                                    <span class="card-icon">üë§</span>
                                    <h3>Objectifs - Contact 1</h3>
                                </div>
                                <div class="card-content">
                                    <div class="checkbox-group">
                                        <label class="checkbox-item">
                                            <input type="checkbox" name="objectifsContact1" value="Constitution d'un patrimoine">
                                            <span class="checkmark"></span>
                                            Constitution d'un patrimoine
                                        </label>
                                        <label class="checkbox-item">
                                            <input type="checkbox" name="objectifsContact1" value="Pr√©paration de la retraite">
                                            <span class="checkmark"></span>
                                            Pr√©paration de la retraite
                                        </label>
                                        <label class="checkbox-item">
                                            <input type="checkbox" name="objectifsContact1" value="Optimisation fiscale">
                                            <span class="checkmark"></span>
                                            Optimisation fiscale
                                        </label>
                                        <label class="checkbox-item">
                                            <input type="checkbox" name="objectifsContact1" value="Transmission du patrimoine">
                                            <span class="checkmark"></span>
                                            Transmission du patrimoine
                                        </label>
                                        <label class="checkbox-item">
                                            <input type="checkbox" name="objectifsContact1" value="Diversification des investissements">
                                            <span class="checkmark"></span>
                                            Diversification des investissements
                                        </label>
                                        <label class="checkbox-item">
                                            <input type="checkbox" name="objectifsContact1" value="Protection du conjoint/famille">
                                            <span class="checkmark"></span>
                                            Protection du conjoint/famille
                                        </label>
                                        <label class="checkbox-item">
                                            <input type="checkbox" name="objectifsContact1" value="Financement des √©tudes">
                                            <span class="checkmark"></span>
                                            Financement des √©tudes
                                        </label>
                                        <label class="checkbox-item">
                                            <input type="checkbox" name="objectifsContact1" value="Investissement locatif">
                                            <span class="checkmark"></span>
                                            Investissement locatif
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-card">
                                <div class="card-header">
                                    <span class="card-icon">üë§</span>
                                    <h3>Objectifs - Contact 2</h3>
                                </div>
                                <div class="card-content">
                                    <div class="checkbox-group">
                                        <label class="checkbox-item">
                                            <input type="checkbox" name="objectifsContact2" value="Constitution d'un patrimoine">
                                            <span class="checkmark"></span>
                                            Constitution d'un patrimoine
                                        </label>
                                        <label class="checkbox-item">
                                            <input type="checkbox" name="objectifsContact2" value="Pr√©paration de la retraite">
                                            <span class="checkmark"></span>
                                            Pr√©paration de la retraite
                                        </label>
                                        <label class="checkbox-item">
                                            <input type="checkbox" name="objectifsContact2" value="Optimisation fiscale">
                                            <span class="checkmark"></span>
                                            Optimisation fiscale
                                        </label>
                                        <label class="checkbox-item">
                                            <input type="checkbox" name="objectifsContact2" value="Transmission du patrimoine">
                                            <span class="checkmark"></span>
                                            Transmission du patrimoine
                                        </label>
                                        <label class="checkbox-item">
                                            <input type="checkbox" name="objectifsContact2" value="Diversification des investissements">
                                            <span class="checkmark"></span>
                                            Diversification des investissements
                                        </label>
                                        <label class="checkbox-item">
                                            <input type="checkbox" name="objectifsContact2" value="Protection du conjoint/famille">
                                            <span class="checkmark"></span>
                                            Protection du conjoint/famille
                                        </label>
                                        <label class="checkbox-item">
                                            <input type="checkbox" name="objectifsContact2" value="Financement des √©tudes">
                                            <span class="checkmark"></span>
                                            Financement des √©tudes
                                        </label>
                                        <label class="checkbox-item">
                                            <input type="checkbox" name="objectifsContact2" value="Investissement locatif">
                                            <span class="checkmark"></span>
                                            Investissement locatif
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Type de demande -->
                <div class="form-section">
                    <div class="section-title">Type de demande</div>
                    <div class="demande-categories">
                        <div class="demande-category">
                            <h4>üí∞ Placement</h4>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Assurance vie">
                                    <span class="checkmark"></span>
                                    Assurance vie
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Contrat de capitalisation">
                                    <span class="checkmark"></span>
                                    Contrat de capitalisation
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="PEA">
                                    <span class="checkmark"></span>
                                    PEA
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="CTO">
                                    <span class="checkmark"></span>
                                    CTO
                                </label>
                            </div>
                        </div>

                        <div class="demande-category">
                            <h4>üè† Immobilier</h4>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Ancien RF">
                                    <span class="checkmark"></span>
                                    Ancien RF
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="D√©ficit foncier">
                                    <span class="checkmark"></span>
                                    D√©ficit foncier
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="LMNP">
                                    <span class="checkmark"></span>
                                    LMNP
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="SCI">
                                    <span class="checkmark"></span>
                                    SCI
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="SCPI">
                                    <span class="checkmark"></span>
                                    SCPI
                                </label>
                            </div>
                        </div>

                        <div class="demande-category">
                            <h4>üìä D√©fiscalisation</h4>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Girardin">
                                    <span class="checkmark"></span>
                                    Girardin
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="FIP/FCPI">
                                    <span class="checkmark"></span>
                                    FIP/FCPI
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Sofica">
                                    <span class="checkmark"></span>
                                    Sofica
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Malraux">
                                    <span class="checkmark"></span>
                                    Malraux
                                </label>
                            </div>
                        </div>

                        <div class="demande-category">
                            <h4>üéØ Retraite</h4>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="PER">
                                    <span class="checkmark"></span>
                                    PER
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Bilan retraite">
                                    <span class="checkmark"></span>
                                    Bilan retraite
                                </label>
                            </div>
                        </div>

                        <div class="demande-category">
                            <h4>üë• Civil</h4>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="PACS">
                                    <span class="checkmark"></span>
                                    PACS
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Mariage">
                                    <span class="checkmark"></span>
                                    Mariage
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Donation entre vifs">
                                    <span class="checkmark"></span>
                                    Donation entre vifs
                                </label>
                            </div>
                        </div>

                        <div class="demande-category">
                            <h4>‚öñÔ∏è Succession</h4>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Estimation de droits">
                                    <span class="checkmark"></span>
                                    Estimation de droits
                                </label>
                            </div>
                        </div>

                        <div class="demande-category">
                            <h4>üìù Autres</h4>
                            <div class="form-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" id="autreDemandeCheckbox" name="typeDemande" value="Autre">
                                    <span class="checkmark"></span>
                                    Autre (pr√©cisez)
                                </label>
                                <textarea id="autreDemandePrecision" name="autreDemandePrecision" placeholder="Pr√©cisez le type de demande..." style="display:none; margin-top: 10px;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pr√©cisions sur la demande -->
                <div class="form-section">
                    <div class="section-title">Pr√©cisions sur la demande</div>
                    <div class="form-card">
                        <div class="card-content">
                            <div class="form-group">
                                <label for="precisionsDemande">D√©tails et pr√©cisions sur la demande globale</label>
                                <textarea id="precisionsDemande" name="precisionsDemande" rows="6" placeholder="D√©crivez en d√©tail la demande, le contexte, les √©l√©ments sp√©cifiques √† prendre en compte, les contraintes particuli√®res, etc."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Options d'envoi -->
                <div class="form-section">
                    <div class="section-title">Options d'envoi</div>
                    <div class="zeendoc-option-section">
                        <label class="checkbox-item zeendoc-option-checkbox">
                            <input type="checkbox" id="envoyerVersZeendocCheckbox" name="envoyerVersZeendoc" checked>
                            <span class="checkmark"></span>
                            <strong>üìÅ Envoyer automatiquement les documents vers ZeenDoc</strong>
                        </label>
                        <p class="help-text">Si cette case est d√©coch√©e, seul l'email aux ing√©nieurs sera envoy√© (sans les pi√®ces jointes vers ZeenDoc).</p>
                        
                        <div id="zeendocWorkflowDetails">
                            <div class="auto-info" style="margin-top: 15px;">
                                <span class="auto-badge">‚ö° ZeenDoc + Email aux ing√©nieurs</span>
                                <small>Envoi automatique complet activ√©</small>
                            </div>
                        </div>

                        <div id="emailSeulDetails" style="display: none;">
                            <div class="warning-info" style="margin-top: 15px;">
                                <span class="warning-badge">‚ö†Ô∏è Email aux ing√©nieurs Uniquement</span>
                                <small>ZeenDoc d√©sactiv√© - Envoi manuel requis pour les documents</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documents obligatoires (SECTION CORRIG√âE) -->
                <div class="form-section">
                    <div class="section-title">Documents obligatoires</div>
                    <div class="document-fields">
                        <div class="document-field zeendoc-field">
                            <label>Fiche de renseignement <span class="required">*</span></label>
                            <div class="file-upload">
                                <span class="file-upload-icon">üìé</span>
                                <div class="file-upload-text">
                                    <p>Glissez vos fichiers ici ou cliquez pour s√©lectionner</p>
                                    <small class="zeendoc-naming">üöÄ Envoi automatique vers ZeenDoc</small>
                                </div>
                                <span class="file-upload-btn">Parcourir</span>
                                <input type="file" id="ficheRenseignement" name="ficheRenseignement" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            </div>
                            <div class="file-help-text">Fiche client compl√®te avec informations personnelles et financi√®res</div>
                            <div class="file-help-text formats">Formats accept√©s: PDF, DOC, DOCX, JPG, PNG</div>
                            <div id="ficheRenseignement_list" class="file-list hidden"></div>
                        </div>

                        <div class="document-field zeendoc-field">
                            <label>Dernier avis d'imposition <span class="required">*</span></label>
                            <div class="file-upload">
                                <span class="file-upload-icon">üìé</span>
                                <div class="file-upload-text">
                                    <p>Glissez vos fichiers ici ou cliquez pour s√©lectionner</p>
                                    <small class="zeendoc-naming">üöÄ Envoi automatique vers ZeenDoc</small>
                                </div>
                                <span class="file-upload-btn">Parcourir</span>
                                <input type="file" id="avisImposition" name="avisImposition" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            </div>
                            <div class="file-help-text">Pour chaque contact si pas d'imposition commune</div>
                            <div class="file-help-text formats">Formats accept√©s: PDF, DOC, DOCX, JPG, PNG</div>
                            <div id="avisImposition_list" class="file-list hidden"></div>
                        </div>

                        <div class="document-field zeendoc-field">
                            <label>Bulletins de salaire <span class="required">*</span></label>
                            <div class="file-upload">
                                <span class="file-upload-icon">üìé</span>
                                <div class="file-upload-text">
                                    <p>Glissez vos fichiers ici ou cliquez pour s√©lectionner</p>
                                    <small class="zeendoc-naming">üöÄ Envoi automatique vers ZeenDoc</small>
                                </div>
                                <span class="file-upload-btn">Parcourir</span>
                                <input type="file" id="bulletinsSalaire" name="bulletinsSalaire" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            </div>
                            <div class="file-help-text">Dernier bulletin + bulletin d√©cembre N-1 pour chaque contact</div>
                            <div class="file-help-text formats">Formats accept√©s: PDF, DOC, DOCX, JPG, PNG</div>
                            <div id="bulletinsSalaire_list" class="file-list hidden"></div>
                        </div>

                        <div class="document-field zeendoc-field">
                            <label>Infos retraite - estimation du montant <span class="required">*</span></label>
                            <div class="file-upload">
                                <span class="file-upload-icon">üìé</span>
                                <div class="file-upload-text">
                                    <p>Glissez vos fichiers ici ou cliquez pour s√©lectionner</p>
                                    <small class="zeendoc-naming">üöÄ Envoi automatique vers ZeenDoc</small>
                                </div>
                                <span class="file-upload-btn">Parcourir</span>
                                <input type="file" id="infosRetraite" name="infosRetraite" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            </div>
                            <div class="file-help-text">Relev√© de situation individuelle, estimation retraite, etc.</div>
                            <div class="file-help-text formats">Formats accept√©s: PDF, DOC, DOCX, JPG, PNG</div>
                            <div id="infosRetraite_list" class="file-list hidden"></div>
                        </div>

                        <div class="document-field zeendoc-field">
                            <label>Derniers relev√©s de placement financier <span class="required">*</span></label>
                            <div class="file-upload">
                                <span class="file-upload-icon">üìé</span>
                                <div class="file-upload-text">
                                    <p>Glissez vos fichiers ici ou cliquez pour s√©lectionner</p>
                                    <small class="zeendoc-naming">üöÄ Envoi automatique vers ZeenDoc</small>
                                </div>
                                <span class="file-upload-btn">Parcourir</span>
                                <input type="file" id="relevesPlacement" name="relevesPlacement" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            </div>
                            <div class="file-help-text">Avec dates pour assurance vie, PEA, comptes titres, etc.</div>
                            <div class="file-help-text formats">Formats accept√©s: PDF, DOC, DOCX, JPG, PNG</div>
                            <div id="relevesPlacement_list" class="file-list hidden"></div>
                        </div>

                        <div class="document-field zeendoc-field">
                            <label>Profil risques <span class="required">*</span></label>
                            <div class="file-upload">
                                <span class="file-upload-icon">üìé</span>
                                <div class="file-upload-text">
                                    <p>Glissez vos fichiers ici ou cliquez pour s√©lectionner</p>
                                    <small class="zeendoc-naming">üöÄ Envoi automatique vers ZeenDoc</small>
                                </div>
                                <span class="file-upload-btn">Parcourir</span>
                                <input type="file" id="profilRisques" name="profilRisques" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            </div>
                            <div class="file-help-text">Document d'√©valuation du profil de risque de l'investisseur</div>
                            <div class="file-help-text formats">Formats accept√©s: PDF, DOC, DOCX, JPG, PNG</div>
                            <div id="profilRisques_list" class="file-list hidden"></div>
                        </div>
                    </div>
                </div>

                <!-- Documents compl√©mentaires -->
                <div class="form-section">
                    <div class="section-title">Documents compl√©mentaires (selon situation)</div>
                    <div class="document-fields">
                        <div class="document-field zeendoc-field">
                            <label>CNI recto/verso + livret de famille</label>
                            <div class="file-upload">
                                <span class="file-upload-icon">üìé</span>
                                <div class="file-upload-text">
                                    <p>Glissez vos fichiers ici ou cliquez pour s√©lectionner</p>
                                    <small class="zeendoc-naming">üöÄ Envoi automatique vers ZeenDoc</small>
                                </div>
                                <span class="file-upload-btn">Parcourir</span>
                                <input type="file" id="cniLivret" name="cniLivret" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            </div>
                            <div class="file-help-text">Pour chaque contact, CNI recto et verso + livret de famille si applicable</div>
                            <div class="file-help-text formats">Formats accept√©s: PDF, DOC, DOCX, JPG, PNG</div>
                            <div id="cniLivret_list" class="file-list hidden"></div>
                        </div>

                        <div class="document-field zeendoc-field">
                            <label>Tableau d'amortissement + offre de pr√™t</label>
                            <div class="file-upload">
                                <span class="file-upload-icon">üìé</span>
                                <div class="file-upload-text">
                                    <p>Glissez vos fichiers ici ou cliquez pour s√©lectionner</p>
                                    <small class="zeendoc-naming">üöÄ Envoi automatique vers ZeenDoc</small>
                                </div>
                                <span class="file-upload-btn">Parcourir</span>
                                <input type="file" id="tableauAmortissement" name="tableauAmortissement" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            </div>
                            <div class="file-help-text">En cas de rachat de cr√©dit ou nouveau pr√™t</div>
                            <div class="file-help-text formats">Formats accept√©s: PDF, DOC, DOCX, JPG, PNG</div>
                            <div id="tableauAmortissement_list" class="file-list hidden"></div>
                        </div>

                        <div class="document-field zeendoc-field">
                            <label>Autres documents pertinents</label>
                            <div class="file-upload">
                                <span class="file-upload-icon">üìé</span>
                                <div class="file-upload-text">
                                    <p>Glissez vos fichiers ici ou cliquez pour s√©lectionner</p>
                                    <small class="zeendoc-naming">üöÄ Envoi automatique vers ZeenDoc</small>
                                </div>
                                <span class="file-upload-btn">Parcourir</span>
                                <input type="file" id="autresDocuments" name="autresDocuments" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            </div>
                            <div class="file-help-text">Testament, clause b√©n√©ficiaire, r√©capitulatif donations, statuts SCI, etc.</div>
                            <div class="file-help-text formats">Formats accept√©s: PDF, DOC, DOCX, JPG, PNG</div>
                            <div id="autresDocuments_list" class="file-list hidden"></div>
                        </div>
                    </div>

                    <div class="zeendoc-workflow-info">
                        <h4>üöÄ Workflow Automatique Ing√©nierie</h4>
                        <ol>
                            <li><strong>Email aux ing√©nieur:</strong> Envoy√© avec archive ZIP si fichiers volumineux</li>
                            <li><strong>ZeenDoc:</strong> Fichiers originaux envoy√©s (emails multiples si n√©cessaire)</li>
                            <li><strong>Nommage:</strong> Format ZeenDoc ing√©nierie avec conseiller</li>
                            <li><strong>Suivi:</strong> Copies de confirmation envoy√©es automatiquement</li>
                        </ol>
                    </div>
                </div>

                <div class="validation-message" id="validationMessage">
                    Veuillez remplir tous les champs obligatoires et joindre les documents requis avant de pouvoir envoyer la demande.
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">Envoyer automatiquement la demande d'ing√©nierie</button>
            </form>
        </div>
    </div>

    <script>
        var uploadedDocuments = {};
        var requiredDocuments = ['ficheRenseignement', 'avisImposition', 'bulletinsSalaire', 'infosRetraite', 'relevesPlacement', 'profilRisques'];

        document.addEventListener('DOMContentLoaded', function() {
            var today = new Date().toISOString().split('T')[0];
            document.getElementById('dateDemande').value = today;
            
            initializeFormEvents();
            initializeFileEvents();
            updateSubmitButton();
        });

        function initializeFormEvents() {
            var situationFamiliale = document.getElementById('situationFamiliale');
            situationFamiliale.addEventListener('change', function() {
                var regimeGroup = document.getElementById('regimeGroup');
                if (this.value === 'Mari√©' || this.value === 'Pacs√©') {
                    regimeGroup.style.display = 'block';
                } else {
                    regimeGroup.style.display = 'none';
                    document.getElementById('regimeMatrimonial').value = '';
                }
            });

            var objectifsCommunsCheckbox = document.getElementById('objectifsCommunsCheckbox');
            objectifsCommunsCheckbox.addEventListener('change', function() {
                var objectifsCommuns = document.getElementById('objectifsCommuns');
                var objectifsSepares = document.getElementById('objectifsSepares');
                
                if (this.checked) {
                    objectifsCommuns.style.display = 'block';
                    objectifsSepares.style.display = 'none';
                    clearCheckboxes('objectifsContact1');
                    clearCheckboxes('objectifsContact2');
                } else {
                    objectifsCommuns.style.display = 'none';
                    objectifsSepares.style.display = 'block';
                    clearCheckboxes('objectifs');
                }
                updateSubmitButton();
            });

            // Gestion de l'envoi vers ZeenDoc
            var envoyerVersZeendocCheckbox = document.getElementById('envoyerVersZeendocCheckbox');
            envoyerVersZeendocCheckbox.addEventListener('change', function() {
                var zeendocWorkflowDetails = document.getElementById('zeendocWorkflowDetails');
                var emailSeulDetails = document.getElementById('emailSeulDetails');
                
                if (this.checked) {
                    zeendocWorkflowDetails.style.display = 'block';
                    emailSeulDetails.style.display = 'none';
                } else {
                    zeendocWorkflowDetails.style.display = 'none';
                    emailSeulDetails.style.display = 'block';
                }
                updateSubmitButton();
            });

            var autreCheckbox = document.getElementById('autreDemandeCheckbox');
            var autrePrecision = document.getElementById('autreDemandePrecision');
            autreCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    autrePrecision.style.display = 'block';
                    autrePrecision.required = true;
                } else {
                    autrePrecision.style.display = 'none';
                    autrePrecision.required = false;
                    autrePrecision.value = '';
                }
            });

            var form = document.getElementById('ingenierieForm');
            var inputs = form.querySelectorAll('input[required], select[required]');
            for (var i = 0; i < inputs.length; i++) {
                inputs[i].addEventListener('change', updateSubmitButton);
                inputs[i].addEventListener('input', updateSubmitButton);
            }

            form.addEventListener('submit', handleFormSubmit);
        }

        function clearCheckboxes(name) {
            var checkboxes = document.querySelectorAll('input[name="' + name + '"]');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = false;
            }
        }

        function initializeFileEvents() {
            var fileInputs = document.querySelectorAll('input[type="file"]');
            for (var i = 0; i < fileInputs.length; i++) {
                fileInputs[i].addEventListener('change', function() {
                    handleDocumentUpload(this.id);
                });
            }

            var fileUploads = document.querySelectorAll('.file-upload');
            for (var i = 0; i < fileUploads.length; i++) {
                setupDragDrop(fileUploads[i]);
            }
        }

        function setupDragDrop(upload) {
            upload.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            upload.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });

            upload.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                var input = this.querySelector('input[type="file"]');
                if (input && e.dataTransfer.files.length > 0) {
                    input.files = e.dataTransfer.files;
                    handleDocumentUpload(input.id);
                }
            });
        }

        function handleDocumentUpload(inputId) {
            const input = document.getElementById(inputId);
            
            // R√©cup√©rer les infos du client
            const nomConseiller = document.getElementById('nomConseiller').value;
            const nomContact1 = document.getElementById('nomContact1').value;
            const prenomContact1 = document.getElementById('prenomContact1').value;
            const secteurConseiller = document.getElementById('secteurConseiller').value;
            
            if (!uploadedDocuments[inputId]) {
                uploadedDocuments[inputId] = [];
            }
        
            if (input.files.length > 0) {
                Array.from(input.files).forEach(file => {
                    // CORRECTION: V√©rifier que le fichier a un nom valide
                    if (!file.name || !file.name.trim()) {
                        console.warn('Fichier sans nom ignor√©:', file);
                        return;
                    }
                    
                    // CORRECTION: V√©rifier que le fichier n'est pas vide
                    if (file.size === 0) {
                        console.warn('Fichier vide ignor√©:', file.name);
                        return;
                    }
                    
                    // G√©n√©rer le nom ZeenDoc automatiquement
                    const nomZeenDoc = genererNomZeenDocIngenierie(
                        file.name, 
                        nomContact1, 
                        prenomContact1, 
                        nomConseiller, 
                        secteurConseiller, 
                        inputId
                    );
                    
                    // V√©rifier si le fichier n'est pas d√©j√† dans la liste
                    const exists = uploadedDocuments[inputId].some(existingFile => 
                        existingFile.nomOriginal === file.name && 
                        existingFile.file.size === file.size &&
                        existingFile.file.lastModified === file.lastModified
                    );
                    
                    if (!exists) {
                        const fileData = {
                            file: file,
                            nomOriginal: file.name,
                            nomZeenDoc: nomZeenDoc,
                            id: Date.now() + Math.random()
                        };
                        
                        uploadedDocuments[inputId].push(fileData);
                        console.log('Fichier ajout√© √† uploadedDocuments:', {
                            inputId: inputId,
                            fileName: file.name,
                            fileSize: file.size,
                            nomZeenDoc: nomZeenDoc
                        });
                    } else {
                        console.log('Fichier d√©j√† pr√©sent, ignor√©:', file.name);
                    }
                });
        
                updateFileList(inputId);
            }
        
            input.value = '';
            updateSubmitButton();
        }


        function genererNomZeenDocIngenierie(nomFichier, nomContact1, prenomContact1, nomConseiller, secteurConseiller, docId) {
            // Extraire l'extension
            var extension = nomFichier.includes('.') ? nomFichier.split('.').pop().toLowerCase() : '';
            
            // Mapper les IDs vers des noms courts
            var mappingDocs = {
                'ficheRenseignement': 'Fiche_Renseignement',
                'avisImposition': 'Avis_Imposition',
                'bulletinsSalaire': 'Bulletins_Salaire',
                'infosRetraite': 'Infos_Retraite',
                'relevesPlacement': 'Releves_Placement',
                'profilRisques': 'Profil_Risques',
                'cniLivret': 'CNI_Livret',
                'tableauAmortissement': 'Tableau_Amortissement',
                'autresDocuments': 'Autres_Documents'
            };
            
            var docType = mappingDocs[docId] || 'Document';
            var dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            var conseillerClean = nomConseiller.replace(/\s+/g, '_');
            var secteurClean = secteurConseiller.replace(/\s+/g, '_');
            
            // V√©rifier que les champs obligatoires sont remplis
            if (!nomContact1 || !prenomContact1) {
                return `INGENIERIE_${docType}_${conseillerClean}_${secteurClean}_${dateStr}${extension ? '.' + extension : ''}`;
            }
            
            return `INGENIERIE_${nomContact1.toUpperCase()}_${prenomContact1}_${docType}_${conseillerClean}_${secteurClean}_${dateStr}${extension ? '.' + extension : ''}`;
        }
        function updateFileList(inputId) {
            var fileList = document.getElementById(inputId + '_list');
            var files = uploadedDocuments[inputId] || [];

            if (files.length > 0) {
                fileList.classList.remove('hidden');
                fileList.innerHTML = '';

                for (var i = 0; i < files.length; i++) {
                    var fileData = files[i];
                    var fileItem = document.createElement('div');
                    fileItem.className = 'file-item zeendoc-item';
                    
                    var fileSize = formatFileSize(fileData.file.size);
                    
                    fileItem.innerHTML = 
                        '<div class="file-item-info">' +
                            '<span class="file-item-icon">üìÑ</span>' +
                            '<div>' +
                                '<div class="file-item-name-original">' + fileData.nomOriginal + '</div>' +
                                '<div class="file-item-name-zeendoc">üìÅ ZeenDoc: ' + fileData.nomZeenDoc + '</div>' +
                                '<div class="file-item-size">' + fileSize + '</div>' +
                            '</div>' +
                        '</div>' +
                        '<button type="button" class="file-item-remove" onclick="removeDocumentFile(\'' + inputId + '\', ' + i + ')">Supprimer</button>';
                    
                    fileList.appendChild(fileItem);
                }

                var addMoreBtn = document.createElement('button');
                addMoreBtn.type = 'button';
                addMoreBtn.className = 'add-more-files';
                addMoreBtn.textContent = 'Ajouter un autre fichier';
                addMoreBtn.onclick = function() {
                    document.getElementById(inputId).click();
                };
                fileList.appendChild(addMoreBtn);
            } else {
                fileList.classList.add('hidden');
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            var k = 1024;
            var sizes = ['B', 'KB', 'MB', 'GB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function removeDocumentFile(inputId, index) {
            if (uploadedDocuments[inputId]) {
                uploadedDocuments[inputId].splice(index, 1);
                
                if (uploadedDocuments[inputId].length === 0) {
                    delete uploadedDocuments[inputId];
                }
                
                updateFileList(inputId);
                updateSubmitButton();
            }
        }

        function updateSubmitButton() {
            var submitBtn = document.getElementById('submitBtn');
            var validationMessage = document.getElementById('validationMessage');
            
            var allFieldsValid = checkRequiredFields();
            var allDocumentsUploaded = checkRequiredDocuments();
            var hasObjectifs = checkObjectifs();
            var hasTypeDemande = checkTypeDemande();

            if (allFieldsValid && allDocumentsUploaded && hasObjectifs && hasTypeDemande) {
                submitBtn.disabled = false;
                validationMessage.classList.remove('show');
            } else {
                submitBtn.disabled = true;
                validationMessage.classList.add('show');
            }
        }

        function checkRequiredFields() {
            var form = document.getElementById('ingenierieForm');
            var requiredInputs = form.querySelectorAll('input[required], select[required]');
            
            for (var i = 0; i < requiredInputs.length; i++) {
                if (!requiredInputs[i].value.trim()) {
                    return false;
                }
            }
            return true;
        }

        function checkRequiredDocuments() {
            var envoyerVersZeendocCheckbox = document.getElementById('envoyerVersZeendocCheckbox');
            console.log('=== CHECK REQUIRED DOCUMENTS ===');
            console.log('ZeenDoc checkbox checked:', envoyerVersZeendocCheckbox.checked);
            
            if (!envoyerVersZeendocCheckbox.checked) {
                console.log('ZeenDoc d√©sactiv√© - pas de documents requis');
                return true;
            }
            
            console.log('Documents requis:', requiredDocuments);
            console.log('Documents upload√©s disponibles:', Object.keys(uploadedDocuments));
            
            for (var i = 0; i < requiredDocuments.length; i++) {
                var docId = requiredDocuments[i];
                var hasFiles = uploadedDocuments[docId] && 
                              Array.isArray(uploadedDocuments[docId]) && 
                              uploadedDocuments[docId].length > 0;
                
                console.log(`${docId}: ${hasFiles ? 'OK' : 'MANQUANT'}`);
                
                if (hasFiles) {
                    // V√©rifier que les fichiers sont valides
                    var validFiles = uploadedDocuments[docId].filter(fileData => 
                        fileData.file && 
                        fileData.file instanceof File && 
                        fileData.file.name && 
                        fileData.file.name.trim() &&
                        fileData.file.size > 0
                    );
                    
                    if (validFiles.length === 0) {
                        console.log(`Document ${docId}: fichiers pr√©sents mais invalides`);
                        return false;
                    } else {
                        console.log(`Document ${docId}: ${validFiles.length} fichier(s) valide(s)`);
                    }
                } else {
                    console.log('Document manquant:', docId);
                    return false;
                }
            }
            
            console.log('Tous les documents requis sont pr√©sents et valides');
            return true;
        }

        function checkObjectifs() {
            var objectifsCommunsCheckbox = document.getElementById('objectifsCommunsCheckbox');
            
            if (objectifsCommunsCheckbox.checked) {
                var objectifsCommuns = document.querySelectorAll('input[name="objectifs"]:checked');
                return objectifsCommuns.length > 0;
            } else {
                var objectifsContact1 = document.querySelectorAll('input[name="objectifsContact1"]:checked');
                var objectifsContact2 = document.querySelectorAll('input[name="objectifsContact2"]:checked');
                return objectifsContact1.length > 0 || objectifsContact2.length > 0;
            }
        }

        function checkTypeDemande() {
            var typeDemandeChecked = document.querySelectorAll('input[name="typeDemande"]:checked');
            return typeDemandeChecked.length > 0;
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            
            console.log('=== D√âBUT ENVOI FORMULAIRE ING√âNIERIE ===');
            
            // V√©rifications pr√©liminaires
            if (!checkRequiredFields() || !checkObjectifs() || !checkTypeDemande()) {
                alert('‚ùå Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            // V√©rifier si ZeenDoc est activ√© et si les documents sont requis
            var envoyerVersZeendocCheckbox = document.getElementById('envoyerVersZeendocCheckbox');
            var zeendocActive = envoyerVersZeendocCheckbox.checked;
            
            if (zeendocActive && !checkRequiredDocuments()) {
                alert('‚ùå Veuillez joindre tous les documents obligatoires pour l\'envoi vers ZeenDoc');
                return;
            }
            
            console.log('ZeenDoc activ√©:', zeendocActive);
            console.log('Documents upload√©s:', uploadedDocuments);
            
            // 1. CR√âER LE FORMDATA avec tous les champs du formulaire
            var formData = new FormData(e.target);
            
            // 2. AJOUTER LES PARAM√àTRES SP√âCIAUX
            
            // CORRECTION MAJEURE: Bien passer le flag ZeenDoc
            formData.append('envoyerVersZeendoc', zeendocActive ? 'true' : 'false');
            console.log('Flag ZeenDoc ajout√© au FormData:', zeendocActive ? 'true' : 'false');
            
            // Gestion des objectifs patrimoniaux
            var objectifsCommunsCheckbox = document.getElementById('objectifsCommunsCheckbox');
            if (objectifsCommunsCheckbox.checked) {
                var objectifs = [];
                var objectifsInputs = document.querySelectorAll('input[name="objectifs"]:checked');
                for (var i = 0; i < objectifsInputs.length; i++) {
                    objectifs.push(objectifsInputs[i].value);
                }
                formData.append('objectifs_selected', JSON.stringify(objectifs));
                formData.append('objectifs_communs', 'true');
                
                console.log('Objectifs communs s√©lectionn√©s:', objectifs);
            } else {
                var objectifsContact1 = [];
                var objectifs1Inputs = document.querySelectorAll('input[name="objectifsContact1"]:checked');
                for (var i = 0; i < objectifs1Inputs.length; i++) {
                    objectifsContact1.push(objectifs1Inputs[i].value);
                }
                
                var objectifsContact2 = [];
                var objectifs2Inputs = document.querySelectorAll('input[name="objectifsContact2"]:checked');
                for (var i = 0; i < objectifs2Inputs.length; i++) {
                    objectifsContact2.push(objectifs2Inputs[i].value);
                }
                
                formData.append('objectifs_contact1', JSON.stringify(objectifsContact1));
                formData.append('objectifs_contact2', JSON.stringify(objectifsContact2));
                formData.append('objectifs_communs', 'false');
                
                console.log('Objectifs Contact 1:', objectifsContact1);
                console.log('Objectifs Contact 2:', objectifsContact2);
            }
            
            // Gestion des types de demande
            var typesDemande = [];
            var typesInputs = document.querySelectorAll('input[name="typeDemande"]:checked');
            for (var i = 0; i < typesInputs.length; i++) {
                typesDemande.push(typesInputs[i].value);
            }
            formData.append('types_demande_selected', JSON.stringify(typesDemande));
            
            console.log('Types de demande s√©lectionn√©s:', typesDemande);
            
            // 3. AJOUTER TOUS LES FICHIERS UPLOAD√âS
            var totalFiles = 0;
            var totalSize = 0;
            
            console.log('=== AJOUT DES FICHIERS ===');
            for (var docId in uploadedDocuments) {
                var filesForDoc = uploadedDocuments[docId];
                console.log(`Traitement ${docId}: ${filesForDoc.length} fichier(s)`);
                
                for (var i = 0; i < filesForDoc.length; i++) {
                    var fileData = filesForDoc[i];
                    
                    // CORRECTION: V√©rifier que le fichier existe et a un nom valide
                    if (fileData.file && fileData.file instanceof File && fileData.file.name && fileData.file.name.trim()) {
                        formData.append(docId, fileData.file);
                        totalFiles++;
                        totalSize += fileData.file.size;
                        
                        console.log(`  ‚úì Ajout√©: ${fileData.file.name} (${formatFileSize(fileData.file.size)})`);
                        console.log(`    ‚Üí Nom ZeenDoc: ${fileData.nomZeenDoc}`);
                    } else {
                        console.warn(`  ‚ö†Ô∏è Fichier invalide pour ${docId}:`, fileData);
                        console.warn(`    - File object:`, fileData.file);
                        console.warn(`    - File name:`, fileData.file ? fileData.file.name : 'NO FILE');
                    }
                }
            }
            
            console.log(`Total: ${totalFiles} fichier(s), ${formatFileSize(totalSize)}`);
            
            // 4. MISE √Ä JOUR DE L'INTERFACE
            var submitBtn = document.getElementById('submitBtn');
            var originalText = submitBtn.textContent;
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Envoi automatique en cours...';
            
            // 5. ENVOI VERS LE BACKEND
            console.log('=== ENVOI VERS LE SERVEUR ===');
            
            fetch('/envoyer-demande-ingenierie', {
                method: 'POST',
                body: formData
            })
            .then(function(response) {
                console.log('Statut r√©ponse:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response.json();
            })
            .then(function(data) {
                console.log('=== R√âPONSE DU SERVEUR ===');
                console.log('R√©ponse compl√®te:', data);
                
                if (data.status === 'success') {
                    // Construction du message de succ√®s
                    var message = '‚úÖ Demande d\'ing√©nierie envoy√©e automatiquement avec succ√®s!\n\n';
                    
                    // Informations sur les fichiers
                    if (data.fichiers_count > 0) {
                        message += `üìÅ ${data.fichiers_count} document(s) trait√©(s):\n`;
                        if (data.fichiers_info && data.fichiers_info.length > 0) {
                            data.fichiers_info.forEach(function(nom) {
                                message += `‚Ä¢ ${nom}\n`;
                            });
                        }
                        message += '\n';
                    }
                    
                    // D√©tails des envois
                    if (data.envoi_auto && data.details_envoi) {
                        message += 'üöÄ ENVOIS AUTOMATIQUES R√âUSSIS:\n\n';
                        
                        // Email principal
                        if (data.details_envoi.email_principal) {
                            message += 'üìß Email principal: ‚úÖ Envoy√©\n';
                        } else {
                            message += 'üìß Email principal: ‚ùå √âchec\n';
                        }
                        
                        // Emails ZeenDoc (seulement si activ√©)
                        if (data.details_envoi.zeendoc_active) {
                            if (data.details_envoi.total_emails_zeendoc > 0) {
                                if (data.details_envoi.total_emails_zeendoc > 1) {
                                    message += `üìÅ ZeenDoc: ${data.details_envoi.total_emails_zeendoc} emails envoy√©s (fichiers volumineux)\n`;
                                    if (data.details_envoi.zeendoc_parties) {
                                        data.details_envoi.zeendoc_parties.forEach(function(partie) {
                                            var status = partie.succes ? '‚úÖ' : '‚ùå';
                                            message += `   ‚îî‚îÄ Partie ${partie.partie}: ${status} ${partie.fichiers_count} fichier(s)\n`;
                                        });
                                    }
                                } else {
                                    message += 'üìÅ ZeenDoc: ‚úÖ Email envoy√©\n';
                                }
                                
                                if (data.adresse_zeendoc) {
                                    message += `üìÆ Adresse ZeenDoc (${data.secteur}): ${data.adresse_zeendoc}\n`;
                                }
                            } else {
                                message += 'üìÅ ZeenDoc: ‚ö†Ô∏è Aucun email envoy√© (pas de fichiers)\n';
                            }
                        } else {
                            message += 'üìÅ ZeenDoc: ‚è≠Ô∏è Envoi d√©sactiv√© (choix utilisateur)\n';
                        }
                        
                        message += '\nüéâ Tous les envois demand√©s ont √©t√© effectu√©s automatiquement !';
                        
                        // Informations sur le secteur
                        if (data.secteur) {
                            message += `\n\nüìç Secteur: ${data.secteur}`;
                        }
                        
                    } else {
                        message += '‚ùå Erreur lors de l\'envoi automatique.\n';
                        message += 'D√©tails techniques:\n';
                        if (data.details_envoi) {
                            message += JSON.stringify(data.details_envoi, null, 2);
                        }
                    }
                    
                    alert(message);
                    
                    // CORRECTION: Demander confirmation avant de r√©initialiser
                    console.log('R√©initialisation automatique du formulaire...');
                    resetForm();
                    
                } else {
                    // Erreur c√¥t√© serveur
                    console.error('Erreur serveur:', data);
                    var errorMessage = '‚ùå Erreur lors de l\'envoi de la demande:\n\n';
                    errorMessage += data.message || 'Erreur inconnue du serveur';
                    
                    if (data.details) {
                        errorMessage += '\n\nD√©tails techniques:\n' + JSON.stringify(data.details, null, 2);
                    }
                    
                    alert(errorMessage);
                }
            })
            .catch(function(error) {
                console.error('=== ERREUR TECHNIQUE ===');
                console.error('Erreur compl√®te:', error);
                
                var errorMessage = '‚ùå Erreur technique lors de l\'envoi:\n\n';
                errorMessage += error.message || 'Erreur de connexion ou de serveur';
                errorMessage += '\n\nVeuillez v√©rifier votre connexion internet et r√©essayer.';
                errorMessage += '\nSi le probl√®me persiste, contactez l\'administrateur.';
                
                alert(errorMessage);
            })
            .finally(function() {
                // Restaurer l'√©tat du bouton dans tous les cas
                console.log('Restauration de l\'interface...');
                
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                
                // Mettre √† jour l'√©tat du bouton selon les validations
                updateSubmitButton();
                
                console.log('=== FIN TRAITEMENT FORMULAIRE ===');
            });
        }
        
        // Fonction helper pour formater la taille des fichiers (si pas d√©j√† d√©finie)
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            var k = 1024;
            var sizes = ['B', 'KB', 'MB', 'GB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        // Fonction de r√©initialisation du formulaire (si pas d√©j√† d√©finie)
        function resetForm() {
            console.log('R√©initialisation du formulaire...');
            
            // R√©initialiser le formulaire HTML
            document.getElementById('ingenierieForm').reset();
            
            // Vider les donn√©es de fichiers
            uploadedDocuments = {};
            console.log('uploadedDocuments vid√©:', uploadedDocuments);
            
            // Remettre la date d'aujourd'hui
            var today = new Date().toISOString().split('T')[0];
            document.getElementById('dateDemande').value = today;
            
            // Restaurer les √©tats par d√©faut
            document.getElementById('regimeGroup').style.display = 'none';
            document.getElementById('autreDemandePrecision').style.display = 'none';
            document.getElementById('objectifsCommuns').style.display = 'block';
            document.getElementById('objectifsSepares').style.display = 'none';
            document.getElementById('objectifsCommunsCheckbox').checked = true;
            document.getElementById('envoyerVersZeendocCheckbox').checked = true;
            document.getElementById('zeendocWorkflowDetails').style.display = 'block';
            document.getElementById('emailSeulDetails').style.display = 'none';
            
            // Cacher toutes les listes de fichiers
            var fileLists = document.querySelectorAll('.file-list');
            for (var i = 0; i < fileLists.length; i++) {
                fileLists[i].classList.add('hidden');
                fileLists[i].innerHTML = '';
            }
            
            // R√©initialiser tous les inputs de fichiers
            var fileInputs = document.querySelectorAll('input[type="file"]');
            for (var i = 0; i < fileInputs.length; i++) {
                fileInputs[i].value = '';
            }
            
            // Mettre √† jour l'√©tat du bouton
            updateSubmitButton();
            
            console.log('Formulaire r√©initialis√© avec succ√®s');
        }

        function debugUploadedFiles() {
            console.log('=== DEBUG UPLOADED FILES ===');
            console.log('Nombre de cat√©gories:', Object.keys(uploadedDocuments).length);
            
            for (var docId in uploadedDocuments) {
                var files = uploadedDocuments[docId];
                console.log(`\nüìÅ ${docId}: ${files.length} fichier(s)`);
                
                files.forEach((fileData, index) => {
                    console.log(`  ${index + 1}. ${fileData.nomOriginal}`);
                    console.log(`     - Taille: ${fileData.file ? fileData.file.size : 'NO FILE'} bytes`);
                    console.log(`     - Type: ${fileData.file ? fileData.file.type : 'NO FILE'}`);
                    console.log(`     - Nom ZeenDoc: ${fileData.nomZeenDoc}`);
                    console.log(`     - File object valide: ${fileData.file instanceof File}`);
                });
            }
            
            console.log('=== FIN DEBUG ===');
        }

        function validateFile(file, inputId) {
            var errors = [];
            
            // V√©rifier le nom
            if (!file.name || !file.name.trim()) {
                errors.push('Nom de fichier manquant');
            }
            
            // V√©rifier la taille
            if (file.size === 0) {
                errors.push('Fichier vide');
            }
            
            // V√©rifier la taille maximale (50MB par exemple)
            var maxSize = 50 * 1024 * 1024; // 50MB
            if (file.size > maxSize) {
                errors.push(`Fichier trop volumineux (max: ${formatFileSize(maxSize)})`);
            }
            
            // V√©rifier le type de fichier
            var allowedTypes = ['.pdf', '.doc', '.docx', '.jpg', '.jpeg', '.png'];
            var fileExtension = file.name.toLowerCase().split('.').pop();
            if (!allowedTypes.includes('.' + fileExtension)) {
                errors.push(`Type de fichier non autoris√©. Types accept√©s: ${allowedTypes.join(', ')}`);
            }
            
            return errors;
        }
    </script>
</body>
</html>









