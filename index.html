<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Demandes Ing√©nierie</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Gestion des Demandes Ing√©nierie</h1>
            <p>Conseil patrimonial et analyse financi√®re personnalis√©e</p>
        </div>

        <div class="form-container">
            <form id="ingenierieForm">
                <!-- Informations g√©n√©rales -->
                <div class="form-section">
                    <div class="section-title">Informations g√©n√©rales</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="nomConseiller">Nom du conseiller *</label>
                            <input type="text" id="nomConseiller" name="nomConseiller" required>
                        </div>
                        <div class="form-group">
                            <label for="typologieContact">Typologie du contact *</label>
                            <select id="typologieContact" name="typologieContact" required>
                                <option value="">S√©lectionner...</option>
                                <option value="Client">Client</option>
                                <option value="Prospect">Prospect</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dateDemande">Date de la demande *</label>
                            <input type="date" id="dateDemande" name="dateDemande" required>
                        </div>
                        <div class="form-group">
                            <label for="dateRdv">Date du prochain RDV</label>
                            <input type="date" id="dateRdv" name="dateRdv">
                        </div>
                        <div class="form-group">
                            <label for="urgence">Urgence *</label>
                            <select id="urgence" name="urgence" required>
                                <option value="Normal">Normal</option>
                                <option value="Urgent">Urgent</option>
                                <option value="Tr√®s urgent">Tr√®s urgent</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="origineContact">Origine du contact</label>
                            <select id="origineContact" name="origineContact">
                                <option value="">S√©lectionner...</option>
                                <option value="Client du PTF">Client du PTF</option>
                                <option value="Client apport√© par la direction">Client apport√© par la direction</option>
                                <option value="Client apport√© par un salari√© OC">Client apport√© par un salari√© OC</option>
                                <option value="Client apport√© par Progressia">Client apport√© par Progressia</option>
                                <option value="Client externe apporter par le CGP">Client externe apporter par le CGP</option>
                                <option value="Recommandation">Recommandation</option>
                                <option value="Prospection">Prospection</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Contacts -->
                <div class="form-section">
                    <div class="section-title">Contacts</div>
                    <div class="contacts-container">
                        <div class="contact-card">
                            <div class="card-header">
                                <span class="card-icon">üë§</span>
                                <h3>Contact 1</h3>
                            </div>
                            <div class="card-content">
                                <div class="form-group">
                                    <label for="nomContact1">Nom *</label>
                                    <input type="text" id="nomContact1" name="nomContact1" required>
                                </div>
                                <div class="form-group">
                                    <label for="prenomContact1">Pr√©nom *</label>
                                    <input type="text" id="prenomContact1" name="prenomContact1" required>
                                </div>
                            </div>
                        </div>

                        <div class="contact-card">
                            <div class="card-header">
                                <span class="card-icon">üë§</span>
                                <h3>Contact 2 (optionnel)</h3>
                            </div>
                            <div class="card-content">
                                <div class="form-group">
                                    <label for="nomContact2">Nom</label>
                                    <input type="text" id="nomContact2" name="nomContact2">
                                </div>
                                <div class="form-group">
                                    <label for="prenomContact2">Pr√©nom</label>
                                    <input type="text" id="prenomContact2" name="prenomContact2">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-grid" style="margin-top: 20px;">
                        <div class="form-group">
                            <label for="situationFamiliale">Situation familiale *</label>
                            <select id="situationFamiliale" name="situationFamiliale" required>
                                <option value="">S√©lectionner...</option>
                                <option value="C√©libataire">C√©libataire</option>
                                <option value="Mari√©">Mari√©</option>
                                <option value="Pacs√©">Pacs√©</option>
                                <option value="Concubin">Concubin</option>
                                <option value="Divorc√©">Divorc√©</option>
                                <option value="Veuf">Veuf</option>
                            </select>
                        </div>
                        <div class="form-group" id="regimeGroup" style="display: none;">
                            <label for="regimeMatrimonial">R√©gime matrimonial</label>
                            <select id="regimeMatrimonial" name="regimeMatrimonial">
                                <option value="">S√©lectionner...</option>
                                <option value="Communaut√© r√©duite aux acqu√™ts">Communaut√© r√©duite aux acqu√™ts</option>
                                <option value="Communaut√© universelle">Communaut√© universelle</option>
                                <option value="S√©paration de biens">S√©paration de biens</option>
                                <option value="Participation aux acqu√™ts">Participation aux acqu√™ts</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Objectifs patrimoniaux -->
                <div class="form-section">
                    <div class="section-title">Objectifs patrimoniaux</div>
                    <div class="form-card">
                        <div class="card-content">
                            <div class="checkbox-group" id="objectifsGroup">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="objectifs" value="Constitution d'un patrimoine">
                                    <span class="checkmark"></span>
                                    Constitution d'un patrimoine
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="objectifs" value="Pr√©paration de la retraite">
                                    <span class="checkmark"></span>
                                    Pr√©paration de la retraite
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="objectifs" value="Optimisation fiscale">
                                    <span class="checkmark"></span>
                                    Optimisation fiscale
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="objectifs" value="Transmission du patrimoine">
                                    <span class="checkmark"></span>
                                    Transmission du patrimoine
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="objectifs" value="Diversification des investissements">
                                    <span class="checkmark"></span>
                                    Diversification des investissements
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="objectifs" value="Protection du conjoint/famille">
                                    <span class="checkmark"></span>
                                    Protection du conjoint/famille
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="objectifs" value="Financement des √©tudes">
                                    <span class="checkmark"></span>
                                    Financement des √©tudes
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="objectifs" value="Investissement locatif">
                                    <span class="checkmark"></span>
                                    Investissement locatif
                                </label>
                            </div>
                            <div class="form-group" style="margin-top: 20px;">
                                <label class="checkbox-item">
                                    <input type="checkbox" id="objectifsCommunsCheckbox" name="objectifsCommuns">
                                    <span class="checkmark"></span>
                                    Les objectifs sont communs aux deux contacts
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Biens immobiliers -->
                <div class="form-section">
                    <div class="section-title">Biens immobiliers et dispositifs</div>
                    <div id="biensContainer">
                        <!-- Les biens seront ajout√©s dynamiquement -->
                    </div>
                    <button type="button" id="ajouterBien" class="add-btn">+ Ajouter un bien immobilier</button>
                </div>

                <!-- Type de demande -->
                <div class="form-section">
                    <div class="section-title">Type de demande</div>
                    <div class="demande-categories">
                        <div class="demande-category">
                            <h4>üí∞ Placement</h4>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Assurance vie">
                                    <span class="checkmark"></span>
                                    Assurance vie
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Contrat de capitalisation">
                                    <span class="checkmark"></span>
                                    Contrat de capitalisation
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="PEA">
                                    <span class="checkmark"></span>
                                    PEA
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="CTO">
                                    <span class="checkmark"></span>
                                    CTO
                                </label>
                            </div>
                        </div>

                        <div class="demande-category">
                            <h4>üè† Immobilier</h4>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Ancien RF">
                                    <span class="checkmark"></span>
                                    Ancien RF
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="D√©ficit foncier">
                                    <span class="checkmark"></span>
                                    D√©ficit foncier
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="LMNP">
                                    <span class="checkmark"></span>
                                    LMNP
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="SCI">
                                    <span class="checkmark"></span>
                                    SCI
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="SCPI">
                                    <span class="checkmark"></span>
                                    SCPI
                                </label>
                            </div>
                        </div>

                        <div class="demande-category">
                            <h4>üìä D√©fiscalisation</h4>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Girardin">
                                    <span class="checkmark"></span>
                                    Girardin
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="FIP/FCPI">
                                    <span class="checkmark"></span>
                                    FIP/FCPI
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Sofica">
                                    <span class="checkmark"></span>
                                    Sofica
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Malraux">
                                    <span class="checkmark"></span>
                                    Malraux
                                </label>
                            </div>
                        </div>

                        <div class="demande-category">
                            <h4>üéØ Retraite</h4>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="PER">
                                    <span class="checkmark"></span>
                                    PER
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Bilan retraite">
                                    <span class="checkmark"></span>
                                    Bilan retraite
                                </label>
                            </div>
                        </div>

                        <div class="demande-category">
                            <h4>üë• Civil</h4>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="PACS">
                                    <span class="checkmark"></span>
                                    PACS
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Mariage">
                                    <span class="checkmark"></span>
                                    Mariage
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Donation entre vifs">
                                    <span class="checkmark"></span>
                                    Donation entre vifs
                                </label>
                            </div>
                        </div>

                        <div class="demande-category">
                            <h4>‚öñÔ∏è Succession</h4>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="typeDemande" value="Estimation de droits">
                                    <span class="checkmark"></span>
                                    Estimation de droits
                                </label>
                            </div>
                        </div>

                        <div class="demande-category">
                            <h4>üìù Autres</h4>
                            <div class="form-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" id="autreDemandeCheckbox" name="typeDemande" value="Autre">
                                    <span class="checkmark"></span>
                                    Autre (pr√©cisez)
                                </label>
                                <textarea id="autreDemandePrecision" name="autreDemandePrecision" placeholder="Pr√©cisez le type de demande..." style="display:none; margin-top: 10px;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documents obligatoires -->
                <div class="form-section">
                    <div class="section-title">Documents obligatoires</div>
                    <div class="document-fields">
                        <div class="document-field">
                            <label>Fiche de renseignement <span class="required">*</span></label>
                            <div class="file-upload">
                                <span class="file-upload-icon">üìé</span>
                                <div class="file-upload-text">
                                    <p>Glissez vos fichiers ici ou cliquez pour s√©lectionner</p>
                                </div>
                                <span class="file-upload-btn">Parcourir</span>
                                <input type="file" id="ficheRenseignement" name="ficheRenseignement" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            </div>
                            <div class="file-help-text">Fiche client compl√®te avec informations personnelles et financi√®res</div>
                            <div class="file-help-text formats">Formats accept√©s: PDF, DOC, DOCX, JPG, PNG</div>
                            <div id="ficheRenseignement_list" class="file-list hidden"></div>
                        </div>

                        <div class="document-field">
                            <label>CNI recto/verso + livret de famille <span class="required">*</span></label>
                            <div class="file-upload">
                                <span class="file-upload-icon">üìé</span>
                                <div class="file-upload-text">
                                    <p>Glissez vos fichiers ici ou cliquez pour s√©lectionner</p>
                                </div>
                                <span class="file-upload-btn">Parcourir</span>
                                <input type="file" id="cniLivret" name="cniLivret" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            </div>
                            <div class="file-help-text">Pour chaque contact, CNI recto et verso + livret de famille si applicable</div>
                            <div class="file-help-text formats">Formats accept√©s: PDF, DOC, DOCX, JPG, PNG</div>
                            <div id="cniLivret_list" class="file-list hidden"></div>
                        </div>

                        <div class="document-field">
                            <label>Dernier avis d'imposition <span class="required">*</span></label>
                            <div class="file-upload">
                                <span class="file-upload-icon">üìé</span>
                                <div class="file-upload-text">
                                    <p>Glissez vos fichiers ici ou cliquez pour s√©lectionner</p>
                                </div>
                                <span class="file-upload-btn">Parcourir</span>
                                <input type="file" id="avisImposition" name="avisImposition" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            </div>
                            <div class="file-help-text">Pour chaque contact si pas d'imposition commune</div>
                            <div class="file-help-text formats">Formats accept√©s: PDF, DOC, DOCX, JPG, PNG</div>
                            <div id="avisImposition_list" class="file-list hidden"></div>
                        </div>

                        <div class="document-field">
                            <label>Bulletins de salaire <span class="required">*</span></label>
                            <div class="file-upload">
                                <span class="file-upload-icon">üìé</span>
                                <div class="file-upload-text">
                                    <p>Glissez vos fichiers ici ou cliquez pour s√©lectionner</p>
                                </div>
                                <span class="file-upload-btn">Parcourir</span>
                                <input type="file" id="bulletinsSalaire" name="bulletinsSalaire" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            </div>
                            <div class="file-help-text">Dernier bulletin + bulletin d√©cembre N-1 pour chaque contact</div>
                            <div class="file-help-text formats">Formats accept√©s: PDF, DOC, DOCX, JPG, PNG</div>
                            <div id="bulletinsSalaire_list" class="file-list hidden"></div>
                        </div>

                        <div class="document-field">
                            <label>Infos retraite - estimation du montant <span class="required">*</span></label>
                            <div class="file-upload">
                                <span class="file-upload-icon">üìé</span>
                                <div class="file-upload-text">
                                    <p>Glissez vos fichiers ici ou cliquez pour s√©lectionner</p>
                                </div>
                                <span class="file-upload-btn">Parcourir</span>
                                <input type="file" id="infosRetraite" name="infosRetraite" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            </div>
                            <div class="file-help-text">Relev√© de situation individuelle, estimation retraite, etc.</div>
                            <div class="file-help-text formats">Formats accept√©s: PDF, DOC, DOCX, JPG, PNG</div>
                            <div id="infosRetraite_list" class="file-list hidden"></div>
                        </div>

                        <div class="document-field">
                            <label>Derniers relev√©s de placement financier <span class="required">*</span></label>
                            <div class="file-upload">
                                <span class="file-upload-icon">üìé</span>
                                <div class="file-upload-text">
                                    <p>Glissez vos fichiers ici ou cliquez pour s√©lectionner</p>
                                </div>
                                <span class="file-upload-btn">Parcourir</span>
                                <input type="file" id="relevesPlacement" name="relevesPlacement" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            </div>
                            <div class="file-help-text">Avec dates pour assurance vie, PEA, comptes titres, etc.</div>
                            <div class="file-help-text formats">Formats accept√©s: PDF, DOC, DOCX, JPG, PNG</div>
                            <div id="relevesPlacement_list" class="file-list hidden"></div>
                        </div>
                    </div>
                </div>

                <!-- Documents compl√©mentaires -->
                <div class="form-section">
                    <div class="section-title">Documents compl√©mentaires (selon situation)</div>
                    <div class="document-fields">
                        <div class="document-field">
                            <label>Tableau d'amortissement + offre de pr√™t</label>
                            <div class="file-upload">
                                <span class="file-upload-icon">üìé</span>
                                <div class="file-upload-text">
                                    <p>Glissez vos fichiers ici ou cliquez pour s√©lectionner</p>
                                </div>
                                <span class="file-upload-btn">Parcourir</span>
                                <input type="file" id="tableauAmortissement" name="tableauAmortissement" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            </div>
                            <div class="file-help-text">En cas de rachat de cr√©dit ou nouveau pr√™t</div>
                            <div class="file-help-text formats">Formats accept√©s: PDF, DOC, DOCX, JPG, PNG</div>
                            <div id="tableauAmortissement_list" class="file-list hidden"></div>
                        </div>

                        <div class="document-field">
                            <label>Autres documents pertinents</label>
                            <div class="file-upload">
                                <span class="file-upload-icon">üìé</span>
                                <div class="file-upload-text">
                                    <p>Glissez vos fichiers ici ou cliquez pour s√©lectionner</p>
                                </div>
                                <span class="file-upload-btn">Parcourir</span>
                                <input type="file" id="autresDocuments" name="autresDocuments" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            </div>
                            <div class="file-help-text">Testament, clause b√©n√©ficiaire, r√©capitulatif donations, statuts SCI, etc.</div>
                            <div class="file-help-text formats">Formats accept√©s: PDF, DOC, DOCX, JPG, PNG</div>
                            <div id="autresDocuments_list" class="file-list hidden"></div>
                        </div>
                    </div>
                </div>

                <div class="validation-message" id="validationMessage">
                    Veuillez remplir tous les champs obligatoires et joindre les documents requis avant de pouvoir envoyer la demande.
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">Envoyer la demande</button>
            </form>
        </div>
    </div>

    <script>
        var uploadedDocuments = {};
        var bienCounter = 0;
        var requiredDocuments = ['ficheRenseignement', 'cniLivret', 'avisImposition', 'bulletinsSalaire', 'infosRetraite', 'relevesPlacement'];

        document.addEventListener('DOMContentLoaded', function() {
            var today = new Date().toISOString().split('T')[0];
            document.getElementById('dateDemande').value = today;
            setupFormEvents();
            setupFileEvents();
            setupBienImmobilier();
            updateSubmitButton();
        });

        function setupFormEvents() {
            var situationFamiliale = document.getElementById('situationFamiliale');
            var regimeGroup = document.getElementById('regimeGroup');
            
            situationFamiliale.addEventListener('change', function() {
                if (this.value === 'Mari√©' || this.value === 'Pacs√©') {
                    regimeGroup.style.display = 'block';
                } else {
                    regimeGroup.style.display = 'none';
                    document.getElementById('regimeMatrimonial').value = '';
                }
            });

            var autreCheckbox = document.getElementById('autreDemandeCheckbox');
            var autrePrecision = document.getElementById('autreDemandePrecision');
            
            autreCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    autrePrecision.style.display = 'block';
                    autrePrecision.required = true;
                } else {
                    autrePrecision.style.display = 'none';
                    autrePrecision.required = false;
                    autrePrecision.value = '';
                }
            });

            var form = document.getElementById('ingenierieForm');
            var inputs = form.querySelectorAll('input[required], select[required]');
            for (var i = 0; i < inputs.length; i++) {
                inputs[i].addEventListener('change', updateSubmitButton);
                inputs[i].addEventListener('input', updateSubmitButton);
            }

            form.addEventListener('submit', handleFormSubmit);
        }

        function setupBienImmobilier() {
            var ajouterBienBtn = document.getElementById('ajouterBien');
            ajouterBienBtn.addEventListener('click', ajouterBienImmobilier);
        }

        function ajouterBienImmobilier() {
            bienCounter++;
            var biensContainer = document.getElementById('biensContainer');
            
            var bienDiv = document.createElement('div');
            bienDiv.className = 'bien-card';
            bienDiv.id = 'bien_' + bienCounter;
            
            bienDiv.innerHTML = '<div class="card-header">' +
                '<span class="card-icon">üè†</span>' +
                '<h3>Bien immobilier ' + bienCounter + '</h3>' +
                '<button type="button" class="remove-btn" onclick="supprimerBien(' + bienCounter + ')">√ó</button>' +
                '</div>' +
                '<div class="card-content">' +
                '<div class="form-group">' +
                '<label for="typeBien_' + bienCounter + '">Type de bien</label>' +
                '<select id="typeBien_' + bienCounter + '" name="typeBien_' + bienCounter + '">' +
                '<option value="">S√©lectionner...</option>' +
                '<option value="Appartement">Appartement</option>' +
                '<option value="Maison">Maison</option>' +
                '<option value="Terrain">Terrain</option>' +
                '<option value="Local commercial">Local commercial</option>' +
                '<option value="Parking/Garage">Parking/Garage</option>' +
                '</select>' +
                '</div>' +
                '<div class="form-group">' +
                '<label for="villeBien_' + bienCounter + '">Ville</label>' +
                '<input type="text" id="villeBien_' + bienCounter + '" name="villeBien_' + bienCounter + '">' +
                '</div>' +
                '<div class="form-group">' +
                '<label for="proprietaireBien_' + bienCounter + '">Propri√©taire</label>' +
                '<select id="proprietaireBien_' + bienCounter + '" name="proprietaireBien_' + bienCounter + '">' +
                '<option value="">S√©lectionner...</option>' +
                '<option value="Contact 1">Contact 1</option>' +
                '<option value="Contact 2">Contact 2</option>' +
                '<option value="Les deux">Les deux</option>' +
                '</select>' +
                '</div>' +
                '<div class="form-group">' +
                '<label for="creditBien_' + bienCounter + '">Cr√©dit en cours</label>' +
                '<select id="creditBien_' + bienCounter + '" name="creditBien_' + bienCounter + '">' +
                '<option value="">S√©lectionner...</option>' +
                '<option value="Non">Non</option>' +
                '</select>' +
                '</div>' +
                '<div class="form-group">' +
                '<label for="dispositifFiscal_' + bienCounter + '">Dispositif fiscal</label>' +
                '<select id="dispositifFiscal_' + bienCounter + '" name="dispositifFiscal_' + bienCounter + '">' +
                '<option value="">S√©lectionner...</option>' +
                '<option value="Oui">Oui</option>' +
                '<option value="Non">Non</option>' +
                '</select>' +
                '</div>' +
                '<div class="form-group" id="dispositifDetail_' + bienCounter + '" style="display: none;">' +
                '<label for="dispositifType_' + bienCounter + '">Type de dispositif</label>' +
                '<select id="dispositifType_' + bienCounter + '" name="dispositifType_' + bienCounter + '">' +
                '<option value="">S√©lectionner...</option>' +
                '<option value="Pinel">Pinel</option>' +
                '<option value="Malraux">Malraux</option>' +
                '<option value="Denormandie">Denormandie</option>' +
                '<option value="LMNP">LMNP</option>' +
                '<option value="D√©ficit foncier">D√©ficit foncier</option>' +
                '<option value="Autre">Autre</option>' +
                '</select>' +
                '</div>' +
                '<div class="form-group">' +
                '<label for="dateSignature_' + bienCounter + '">Date de signature</label>' +
                '<input type="date" id="dateSignature_' + bienCounter + '" name="dateSignature_' + bienCounter + '">' +
                '</div>' +
                '<div class="form-group">' +
                '<label for="dateAchevement_' + bienCounter + '">Date d\'ach√®vement</label>' +
                '<input type="date" id="dateAchevement_' + bienCounter + '" name="dateAchevement_' + bienCounter + '">' +
                '</div>' +
                '<div class="form-group">' +
                '<label for="prixRevient_' + bienCounter + '">Prix de revient (‚Ç¨)</label>' +
                '<input type="number" id="prixRevient_' + bienCounter + '" name="prixRevient_' + bienCounter + '" min="0" step="0.01">' +
                '</div>' +
                '</div>';
            
            biensContainer.appendChild(bienDiv);
            
            var dispositifSelect = document.getElementById('dispositifFiscal_' + bienCounter);
            var dispositifDetail = document.getElementById('dispositifDetail_' + bienCounter);
            
            dispositifSelect.addEventListener('change', function() {
                if (this.value === 'Oui') {
                    dispositifDetail.style.display = 'block';
                } else {
                    dispositifDetail.style.display = 'none';
                    document.getElementById('dispositifType_' + bienCounter).value = '';
                }
            });
        }

        function supprimerBien(id) {
            var bienCard = document.getElementById('bien_' + id);
            if (bienCard) {
                bienCard.remove();
            }
        }

        function setupFileEvents() {
            var fileInputs = document.querySelectorAll('input[type="file"]');
            for (var i = 0; i < fileInputs.length; i++) {
                fileInputs[i].addEventListener('change', function() {
                    handleDocumentUpload(this.id);
                });
            }

            var fileUploads = document.querySelectorAll('.file-upload');
            for (var i = 0; i < fileUploads.length; i++) {
                fileUploads[i].addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('dragover');
                });

                fileUploads[i].addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                });

                fileUploads[i].addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    var input = this.querySelector('input[type="file"]');
                    if (input && e.dataTransfer.files.length > 0) {
                        input.files = e.dataTransfer.files;
                        handleDocumentUpload(input.id);
                    }
                });
            }
        }

        function handleDocumentUpload(inputId) {
            var input = document.getElementById(inputId);
            
            if (!uploadedDocuments[inputId]) {
                uploadedDocuments[inputId] = [];
            }

            if (input.files.length > 0) {
                for (var i = 0; i < input.files.length; i++) {
                    var file = input.files[i];
                    var exists = false;
                    for (var j = 0; j < uploadedDocuments[inputId].length; j++) {
                        if (uploadedDocuments[inputId][j].name === file.name && uploadedDocuments[inputId][j].size === file.size) {
                            exists = true;
                            break;
                        }
                    }
                    
                    if (!exists) {
                        uploadedDocuments[inputId].push({
                            file: file,
                            id: Date.now() + Math.random()
                        });
                    }
                }

                updateFileList(inputId);
            }

            input.value = '';
            updateSubmitButton();
        }

        function updateFileList(inputId) {
            var fileList = document.getElementById(inputId + '_list');
            var files = uploadedDocuments[inputId] || [];

            if (files.length > 0) {
                fileList.classList.remove('hidden');
                fileList.innerHTML = '';

                for (var i = 0; i < files.length; i++) {
                    var fileData = files[i];
                    var fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    
                    var fileSize = formatFileSize(fileData.file.size);
                    
                    fileItem.innerHTML = '<div class="file-item-info">' +
                        '<span class="file-item-icon">üìÑ</span>' +
                        '<div>' +
                        '<div class="file-item-name">' + fileData.file.name + '</div>' +
                        '<div class="file-item-size">' + fileSize + '</div>' +
                        '</div>' +
                        '</div>' +
                        '<button type="button" class="file-item-remove" onclick="removeDocumentFile(\'' + inputId + '\', ' + i + ')">Supprimer</button>';
                    fileList.appendChild(fileItem);
                }

                var addMoreBtn = document.createElement('button');
                addMoreBtn.type = 'button';
                addMoreBtn.className = 'add-more-files';
                addMoreBtn.textContent = 'Ajouter un autre fichier';
                addMoreBtn.onclick = function() {
                    document.getElementById(inputId).click();
                };
                fileList.appendChild(addMoreBtn);
            } else {
                fileList.classList.add('hidden');
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            var k = 1024;
            var sizes = ['B', 'KB', 'MB', 'GB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function removeDocumentFile(inputId, index) {
            if (uploadedDocuments[inputId]) {
                uploadedDocuments[inputId].splice(index, 1);
                
                if (uploadedDocuments[inputId].length === 0) {
                    delete uploadedDocuments[inputId];
                }
                
                updateFileList(inputId);
                updateSubmitButton();
            }
        }

        function updateSubmitButton() {
            var submitBtn = document.getElementById('submitBtn');
            var validationMessage = document.getElementById('validationMessage');
            
            var form = document.getElementById('ingenierieForm');
            var requiredInputs = form.querySelectorAll('input[required], select[required]');
            var allFieldsValid = true;
            
            for (var i = 0; i < requiredInputs.length; i++) {
                if (!requiredInputs[i].value.trim()) {
                    allFieldsValid = false;
                    break;
                }
            }

            var allDocumentsUploaded = true;
            for (var i = 0; i < requiredDocuments.length; i++) {
                var docId = requiredDocuments[i];
                if (!uploadedDocuments[docId] || uploadedDocuments[docId].length === 0) {
                    allDocumentsUploaded = false;
                    break;
                }
            }

            var objectifsChecked = document.querySelectorAll('input[name="objectifs"]:checked');
            var hasObjectifs = objectifsChecked.length > 0;

            var typeDemandeChecked = document.querySelectorAll('input[name="typeDemande"]:checked');
            var hasTypeDemande = typeDemandeChecked.length > 0;

            if (allFieldsValid && allDocumentsUploaded && hasObjectifs && hasTypeDemande) {
                submitBtn.disabled = false;
                validationMessage.classList.remove('show');
            } else {
                submitBtn.disabled = true;
                validationMessage.classList.add('show');
            }
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            
            var formData = new FormData(e.target);
            
            for (var docId in uploadedDocuments) {
                var files = uploadedDocuments[docId];
                for (var i = 0; i < files.length; i++) {
                    formData.append(docId, files[i].file);
                }
            }

            var objectifs = [];
            var objectifsInputs = document.querySelectorAll('input[name="objectifs"]:checked');
            for (var i = 0; i < objectifsInputs.length; i++) {
                objectifs.push(objectifsInputs[i].value);
            }
            formData.append('objectifs_selected', JSON.stringify(objectifs));

            var typesDemande = [];
            var typesInputs = document.querySelectorAll('input[name="typeDemande"]:checked');
            for (var i = 0; i < typesInputs.length; i++) {
                typesDemande.push(typesInputs[i].value);
            }
            formData.append('types_demande_selected', JSON.stringify(typesDemande));

            var biens = [];
            var bienCards = document.querySelectorAll('.bien-card');
            for (var i = 0; i < bienCards.length; i++) {
                var card = bienCards[i];
                var id = card.id.split('_')[1];
                var bien = {
                    type: getValue('typeBien_' + id),
                    ville: getValue('villeBien_' + id),
                    proprietaire: getValue('proprietaireBien_' + id),
                    credit: getValue('creditBien_' + id),
                    dispositifFiscal: getValue('dispositifFiscal_' + id),
                    dispositifType: getValue('dispositifType_' + id),
                    dateSignature: getValue('dateSignature_' + id),
                    dateAchevement: getValue('dateAchevement_' + id),
                    prixRevient: getValue('prixRevient_' + id)
                };
                biens.push(bien);
            }
            formData.append('biens_immobiliers', JSON.stringify(biens));

            var submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Envoi en cours...';

            setTimeout(function() {
                alert('Demande d\'ing√©nierie envoy√©e avec succ√®s !');
                
                document.getElementById('ingenierieForm').reset();
                uploadedDocuments = {};
                document.getElementById('biensContainer').innerHTML = '';
                bienCounter = 0;
                
                var today = new Date().toISOString().split('T')[0];
                document.getElementById('dateDemande').value = today;
                
                document.getElementById('regimeGroup').style.display = 'none';
                document.getElementById('autreDemandePrecision').style.display = 'none';
                
                var fileLists = document.querySelectorAll('.file-list');
                for (var i = 0; i < fileLists.length; i++) {
                    fileLists[i].classList.add('hidden');
                    fileLists[i].innerHTML = '';
                }
                
                submitBtn.disabled = false;
                submitBtn.textContent = 'Envoyer la demande d\'ing√©nierie';
                updateSubmitButton();
            }, 2000);
        }

        function getValue(elementId) {
            var element = document.getElementById(elementId);
            return element ? element.value : '';
        }
    </script>
</body>
</html>